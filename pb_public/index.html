<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>发票管理系统</title>

  <link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css" integrity="sha512-2bBQCjcnw658Lho4nlXJcc6WkV/UxpE/sAokbXPxQNGqmNdQrWqtw26Ns9kFF/yG792pKR1Sx8/Y1Lf1XN4GKA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" integrity="sha512-t7Few9xlddEmgd3oKZQahkNI4dS6l80+eGEzFQiqtyVYdvcSG2D3Iub77R20BdotfRPA9caaRkg1tyaJiPmO0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />  
  <link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/flatpickr/4.6.13/flatpickr.min.css" integrity="sha512-MQXduO8IQnJVq1qmySpN87QQkiR1bZHtorbJBD0tzy7/0U9+YIC93QWHeGTEoojMVHWWNkoCp8V6OzVSYrX0oQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="css/style.css?v=1.0.2" />

</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="bi bi-receipt-cutoff me-2"></i><strong>发票管理</strong>系统</a>
      <div class="d-flex ms-auto align-items-center">
        <button id="theme-toggler" class="btn btn-outline-secondary btn-sm me-3">
          <i class="bi bi-sun-fill"></i>
        </button>
        <img id="currentAvatar" class="rounded-circle me-2" style="width:32px;height:32px;display:none" alt="avatar">
        <span id="currentUser" class="navbar-text me-3" style="display:none"></span>
        <button id="logoutBtn" class="btn btn-outline-secondary btn-sm" style="display:none"><i class="bi bi-box-arrow-right me-1"></i> <span>退出</span></button>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div id="loginSection" class="row justify-content-center">
      <div class="col-md-5">
        <div class="card card-login mt-5">
          <div class="card-header"><h3 class="text-center my-3">登录</h3></div>
          <div class="card-body p-4">
            <form id="loginForm">
              <div class="form-floating mb-3">
                <input class="form-control" id="email" type="email" placeholder="name@example.com" required autocomplete="username" />
                <label for="email">邮箱</label>
              </div>
              <div class="form-floating mb-4">
                <input class="form-control" id="password" type="password" placeholder="Password" required autocomplete="current-password" />
                <label for="password">密码</label>
              </div>
              <button class="btn btn-primary w-100 btn-lg" type="submit">登录</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div id="mainSection" style="display:none">
      <div class="main-card">
        <div class="controls-header">
            <div id="paginationControlsWrapper" class="d-flex align-items-center gap-3">
                <div class="d-flex align-items-center">
                    <select id="itemsPerPageSelect" class="form-select d-inline-block w-auto">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="9999">All</option>
                    </select>
                    <label for="itemsPerPageSelect" class="form-label mb-0 ms-2 text-muted">/ 页</label>
                </div>
                <nav aria-label="Page navigation">
                    <ul id="pagination" class="pagination mb-0"></ul>
                </nav>
            </div>
            <button class="btn btn-primary d-flex align-items-center" id="addInvoiceBtn"><i class="bi bi-plus-circle-fill me-2"></i> <span>添加发票</span></button>
        </div>

        <div class="search-filter-controls">
            <div class="input-group">
                <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                <input id="searchInput" class="form-control border-start-0" placeholder="按发票号、供应商或描述搜索... (Ctrl+F)">
            </div>
            <select id="statusFilter" class="form-select">
                <option value="">所有状态</option>
                <option value="pending_application">待申请</option>
                <option value="in_invoicing">开票中</option>
                <option value="in_reimbursement">报销中</option>
                <option value="reimbursed">已报销</option>
            </select>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
            <thead>
                <tr>
                <th scope="col" style="width: 30px;"><input type="checkbox" id="selectAllCheckbox" class="form-check-input row-select-checkbox"></th>
                <th scope="col" data-sort-by="invoice_number" class="cursor-pointer">发票号 <i class="bi bi-sort-alpha-down sort-indicator"></i></th>
                <th scope="col" data-sort-by="invoice_date" class="cursor-pointer" style="width: 120px;">日期 <i class="bi bi-sort-alpha-down sort-indicator"></i></th>
                <th scope="col" data-sort-by="vendor" class="cursor-pointer">供应商 <i class="bi bi-sort-alpha-down sort-indicator"></i></th>
                <th scope="col" data-sort-by="amount" class="cursor-pointer" style="width: 130px;">金额 <i class="bi bi-sort-numeric-down sort-indicator"></i></th>
                <th scope="col" data-sort-by="status" class="cursor-pointer" style="width: 120px;">状态 <i class="bi bi-sort-alpha-down sort-indicator"></i></th>
                <th scope="col">描述</th>
                <th scope="col" style="width: 100px;">附件</th>
                <th scope="col" style="width: 120px;" class="text-end">操作</th>
                </tr>
            </thead>
            <tbody id="invoiceList">
            </tbody>
            <tfoot id="noInvoicesMessage" style="display: none;">
                <tr>
                <td colspan="9" class="text-center py-5 text-muted">
                    <i class="bi bi-cloud-slash fs-1"></i>
                    <p class="mt-2">暂无发票数据</p>
                </td>
                </tr>
            </tfoot>
            </table>
        </div>

        <div id="loading" class="text-center py-5" style="display:none">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-2">加载数据中...</p>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="modalTitle" class="modal-title">添加发票</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4">
          <form id="invoiceForm">
            <input type="hidden" id="invoiceId">
            <div class="row">
              <!-- Left Column -->
              <div class="col-md-7">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="invoiceNumber" class="form-label">发票号码</label>
                    <input id="invoiceNumber" name="invoice_number" class="form-control" placeholder="发票号码" required>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="invoiceDate" class="form-label">日期</label>
                    <input id="invoiceDate" name="invoice_date" type="text" class="form-control" placeholder="选择日期" required>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="vendor" class="form-label">供应商</label>
                  <input id="vendor" name="vendor" class="form-control" placeholder="供应商" required>
                </div>
                 <div class="mb-3">
                  <label for="amount" class="form-label">金额</label>
                  <input id="amount" name="amount" type="number" step="0.01" class="form-control" placeholder="金额" required>
                </div>
                <div class="mb-3">
                  <label for="description" class="form-label">描述</label>
                  <textarea id="description" name="description" class="form-control" placeholder="描述" rows="4"></textarea>
                </div>
              </div>
              <!-- Right Column -->
              <div class="col-md-5">
                <div class="form-sidebar p-3 rounded">
                    <div class="mb-3">
                        <label for="status" class="form-label">状态</label>
                        <select id="status" name="status" class="form-select">
                        <option value="pending_application">待申请</option>
                        <option value="in_invoicing">开票中</option>
                        <option value="in_reimbursement">报销中</option>
                        <option value="reimbursed">已报销</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">附件 (PDF)</label>
                        <div>
                            <input type="file" id="attachments" name="attachments" class="d-none" accept=".pdf" multiple>
                            <label for="attachments" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-paperclip"></i> 选择文件
                            </label>
                            <span id="file-chosen-text" class="d-block text-center text-muted mt-2">未选择文件</span>
                        </div>
                        <div id="attachmentPreview" class="attachment-preview mt-3"></div>
                    </div>
                </div>
              </div>
            </div>
            
            <div class="modal-footer d-flex justify-content-between mt-3">
              <button type="button" class="btn btn-outline-secondary" id="recognizeInvoiceNumberBtn"><i class="bi bi-cpu me-1"></i> 识别 PDF</button>
              <div>
                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">关闭</button>
                <button id="saveInvoiceBtn" class="btn btn-primary" type="submit">保存</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteModalLabel">确认删除</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          您确定要删除此发票吗？此操作不可撤销。
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
        </div>
      </div>
    </div>
  </div>

  <div id="batchActions" style="display: none;">
    <div class="batch-info-float">
        已选 <span id="selectedCount">0</span> 张 · 总计 ¥<span id="totalAmountValue">0.00</span>
    </div>

    <select id="batchStatusSelect" class="form-select form-select-sm" style="width: auto; max-width: 120px;">
        <option value="">更改状态...</option>
        <option value="pending_application">待申请</option>
        <option value="in_invoicing">开票中</option>
        <option value="in_reimbursement">报销中</option>
        <option value="reimbursed">已报销</option>
    </select>

    <button id="batchSetStatusBtn" class="btn btn-sm btn-light text-dark fw-bold"><i class="bi bi-check2"></i> 应用</button>
    <div class="vr bg-light mx-1 opacity-25"></div> 
    <button id="batchDownloadBtn" class="btn btn-sm btn-outline-light" title="下载选中"><i class="bi bi-download"></i></button>
    <button id="batchDeleteBtn" class="btn btn-sm btn-outline-danger" title="删除选中"><i class="bi bi-trash"></i></button>
    <button id="deselectAllBtn" class="btn btn-sm btn-link text-white text-decoration-none" title="取消选择"><i class="bi bi-x-lg"></i></button>
  </div>

  <script src="https://s4.zstatic.net/ajax/libs/bootstrap/5.3.8/js/bootstrap.bundle.min.js" integrity="sha512-HvOjJrdwNpDbkGJIG2ZNqDlVqMo77qbs4Me4cah0HoDrfhrbA+8SBlZn1KrvAQw7cILLPFJvdwIgphzQmMm+Pw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://s4.zstatic.net/ajax/libs/pocketbase/0.26.2/pocketbase.umd.min.js" integrity="sha512-23hTPP5Tt6X+FXEQTtMkxAI7sRyPG0lUvhTsoAgYn8nFZ0jMO7ZFo7Qy9xKUyKbQ2dWUo8pvkXeVcta8on3d4Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://s4.zstatic.net/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://s4.zstatic.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-Qlv6VSKh1gDKGoJbnyA5RMXYcvnpIqhO++MhIM2fStMcGT9i2T//tSwYFlcyoRRDcDZ+TYHpH8azBBCyhpSeqw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://s4.zstatic.net/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-q+4liFwdPC/bNdhUpZx6aXDx/h77yEQtn4I1slHydcbZK34nLaR3cAeYSJshoxIOq3mjEf7xJE8YWIUHMn+oCQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://s4.zstatic.net/ajax/libs/flatpickr/4.6.13/flatpickr.min.js" integrity="sha512-K/oyQtMXpxI4+K0W7H25UopjM8pzq0yrVdFdG21Fh5dBe91I40pDd9A4lzNlHPHBIP2cwZuoxaUSX0GJSObvGA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://s4.zstatic.net/ajax/libs/flatpickr/4.6.13/l10n/zh.min.js" integrity="sha512-KU9LjAMoAxs8u2DU62DsIID671imkYuyOkE0/wbjVZDRM259WxX5IhQsWTTBMhtdnhviZEqfkdhG09k7JVf9pg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://s4.zstatic.net/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    // ⚠️ 修复2：使用 CDN 的 CMaps 路径，确保中文不乱码
    pdfjsLib.GlobalWorkerOptions.cMapUrl = 'https://s4.zstatic.net/ajax/libs/pdf.js/3.11.174/cmaps/';
    pdfjsLib.GlobalWorkerOptions.cMapPacked = true;
  </script>

  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    </div>

  <script type="module" src="js/app.js?v=1.0.4"></script>
  <script>
    (function() {
        // This is a self-contained script to handle theme switching,
        // to avoid any race conditions or module loading issues.
        try {
            const themeToggler = document.getElementById('theme-toggler');
            const body = document.body;
            
            if (!themeToggler) {
                console.error("Theme toggler button not found.");
                return;
            }

            const icon = themeToggler.querySelector('i');
            if (!icon) {
                console.error("Theme toggler icon not found.");
                return;
            }

            function applyTheme(theme) {
                if (theme === 'dark') {
                    body.classList.add('dark-mode');
                    icon.classList.remove('bi-sun-fill');
                    icon.classList.add('bi-moon-fill');
                } else {
                    body.classList.remove('dark-mode');
                    icon.classList.remove('bi-moon-fill');
                    icon.classList.add('bi-sun-fill');
                }
            }

            themeToggler.addEventListener('click', function() {
                const newTheme = body.classList.contains('dark-mode') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });

            // Set initial theme on load
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const defaultTheme = savedTheme || (prefersDark ? 'dark' : 'light');
            applyTheme(defaultTheme);

        } catch (e) {
            console.error("Critical error in theme switcher script:", e);
        }
    })();
  </script>
</body>
</html>