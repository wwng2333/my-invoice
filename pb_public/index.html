<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>发票管理系统</title>

  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css" integrity="sha512-2bBQCjcnw658Lho4nlXJcc6WkV/UxpE/sAokbXPxQNGqmNdQrWqtw26Ns9kFF/yG792pKR1Sx8/Y1Lf1XN4GKA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" integrity="sha512-t7Few9xlddEmgd3oKZQahkNI4dS6l80+eGEzFQiqtyVYdvcSG2D3Iub77R20BdotfRPA9caaRkg1tyaJiPmO0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />  
  <link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/flatpickr/4.6.13/flatpickr.min.css" integrity="sha512-MQXduO8IQnJVq1qmySpN87QQkiR1bZHtorbJBD0tzy7/0U9+YIC93QWHeGTEoojMVHWWNkoCp8V6OzVSYrX0oQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    body{background:#f8f9fa}
    .invoice-card{transition:.2s;cursor:pointer}
    .invoice-card:hover{transform:translateY(-4px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .invoice-card.selected{background:#d0eaff!important;border-color:#0d6efd!important}
    #batchActions{position:fixed;bottom:20px;right:20px;z-index:1050;display:none}

    /* Custom table styles */
    .table th, .table td {
      padding: 0.75rem;
      vertical-align: middle;
    }
    .table thead th {
      position: sticky;
      top: 0;
      background-color: #f8f9fa; /* Match body background or a slightly different shade */
      z-index: 10;
      box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
    }
    .table-responsive {
      overflow-y: auto;
      max-height: 70vh; /* Adjust as needed for desired scrollable height */
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .table thead th:nth-child(7), /* 描述 */
      .table tbody td:nth-child(7),
      .table thead th:nth-child(8), /* 附件 */
      .table tbody td:nth-child(8) {
        display: none;
      }
    }

    @media (max-width: 768px) {
      #currentUser {
        display: none !important;
      }

      #batchStatusSelect,
      #batchActions span,
      #addInvoiceBtn span,
      #logoutBtn span {
        display: none !important;
      }
      
      .pagination-controls-wrapper {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .pagination-controls-wrapper > div:first-child {
        margin-bottom: 10px;
      }
    }
    
    /* Enhanced styles for better UX */
    .navbar-brand {
      font-weight: 600;
    }
    
    .card {
      border-radius: 10px;
    }
    
    .btn-group.batch-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .batch-info-btn {
      border-radius: 50px;
      font-weight: 600;
      padding: 0.5rem 1rem;
      min-width: 40px;
      min-height: 40px;
    }
    
    .search-controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .search-controls > div {
      flex: 1;
      min-width: 200px;
    }
    
    .invoice-actions .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }
    
    .attachment-preview {
      max-height: 100px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .status-badge {
      font-weight: 500;
      padding: 0.35em 0.65em;
    }
    
    .table th {
      font-weight: 600;
      color: #495057;
    }
    
    .sort-indicator {
      opacity: 0.7;
      margin-left: 0.25rem;
    }
    
    .sort-active .sort-indicator {
      opacity: 1;
      color: #0d6efd;
    }
  </style>
</head>
<body>
  <!-- 顶栏 -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="bi bi-receipt-cutoff"></i> 发票管理系统</a>
      <div class="d-flex ms-auto align-items-center">
        <img id="currentAvatar" class="rounded-circle me-2" style="width:32px;height:32px;display:none" alt="avatar">
         <span id="currentUser" class="text-light me-3" style="display:none"></span>
        <button id="logoutBtn" class="btn btn-outline-light" style="display:none"><i class="bi bi-box-arrow-right"></i> <span>退出</span></button>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- 登录区 -->
    <div id="loginSection" class="row justify-content-center">
      <div class="col-md-5">
        <div class="card shadow-lg border-0 rounded-lg mt-5">
          <div class="card-header"><h3 class="text-center my-3">登录</h3></div>
          <div class="card-body">
            <form id="loginForm">
              <div class="form-floating mb-3">
                <input class="form-control" id="email" type="email" placeholder="name@example.com" required />
                <label for="email">邮箱</label>
              </div>
              <div class="form-floating mb-3">
                <input class="form-control" id="password" type="password" placeholder="Password" required />
                <label for="password">密码</label>
              </div>
              <button class="btn btn-primary w-100" type="submit">登录</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- 主区 -->
    <div id="mainSection" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div class="pagination-controls-wrapper d-flex align-items-center gap-3">
          <div class="d-flex align-items-center">
            <label for="itemsPerPageSelect" class="form-label mb-0 me-2">每页显示：</label>
            <select id="itemsPerPageSelect" class="form-select form-select-sm d-inline-block w-auto" style="vertical-align: middle;">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="9999">全部</option>
            </select>
          </div>
          <nav aria-label="Page navigation">
            <ul id="pagination" class="pagination mb-0" style="vertical-align: middle;">
              <!-- Pagination links will be injected here by JavaScript -->
            </ul>
          </nav>
        </div>
        <button class="btn btn-primary d-flex align-items-center" id="addInvoiceBtn"><i class="bi bi-plus-circle-fill me-1"></i> <span>添加发票</span></button>
      </div>

      <!-- 搜索过滤 -->
      <div class="search-controls mb-3">
        <div><input id="searchInput" class="form-control" placeholder="按发票号、供应商或描述搜索..."></div>
        <div>
          <select id="statusFilter" class="form-select">
            <option value="">所有状态</option>
            <option value="pending">待处理</option>
            <option value="approved">已批准</option>
            <option value="rejected">已拒绝</option>
          </select>
        </div>
      </div>

      <!-- 列表 -->
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th scope="col" style="width: 30px;"><input type="checkbox" id="selectAllCheckbox"></th>
              <th scope="col" id="sortInvoiceNumber" data-sort-by="invoice_number" data-sort-order="asc" style="cursor: pointer; min-width: 120px;">发票号 <i class="bi bi-sort-alpha-down sort-indicator"></i></th>
              <th scope="col" id="sortInvoiceDate" data-sort-by="invoice_date" data-sort-order="desc" style="cursor: pointer; width: 120px;">日期 <i class="bi bi-sort-alpha-down sort-indicator"></i></th>
              <th scope="col" id="sortVendor" data-sort-by="vendor" data-sort-order="asc" style="cursor: pointer; min-width: 120px;">供应商 <i class="bi bi-sort-alpha-down sort-indicator"></i></th>
              <th scope="col" id="sortAmount" data-sort-by="amount" data-sort-order="asc" style="cursor: pointer; width: 120px;">金额 <i class="bi bi-sort-numeric-down sort-indicator"></i></th>
              <th scope="col" id="sortStatus" data-sort-by="status" data-sort-order="asc" style="cursor: pointer; width: 100px;">状态 <i class="bi bi-sort-alpha-down sort-indicator"></i></th>
              <th scope="col" style="min-width: 150px;">描述</th>
              <th scope="col" style="width: 100px;">附件</th>
              <th scope="col" style="width: 120px;">操作</th>
            </tr>
          </thead>
          <tbody id="invoiceList">
            <!-- 发票行将在这里动态加载 -->
          </tbody>
          <tfoot id="noInvoicesMessage" style="display: none;">
            <tr>
              <td colspan="9" class="text-center py-3 text-muted">暂无发票数据</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div id="loading" class="text-center mt-5" style="display:none">
        <div class="spinner-border text-primary"></div>
      </div>
    </div>
  </div>

  <!-- 发票表单模态框 -->
  <div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="modalTitle" class="modal-title">添加发票</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="invoiceForm">
            <input type="hidden" id="invoiceId">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="invoiceNumber" class="form-label">发票号码</label>
                <input id="invoiceNumber" name="invoice_number" class="form-control" placeholder="发票号码" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="invoiceDate" class="form-label">日期</label>
                <input id="invoiceDate" name="invoice_date" type="text" class="form-control" placeholder="选择日期" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="vendor" class="form-label">供应商</label>
                <input id="vendor" name="vendor" class="form-control" placeholder="供应商" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="amount" class="form-label">金额</label>
                <input id="amount" name="amount" type="number" step="0.01" class="form-control" placeholder="金额" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="taxAmount" class="form-label">税额</label>
                <input id="taxAmount" name="tax_amount" type="number" step="0.01" class="form-control" placeholder="税额">
              </div>
              <div class="col-md-6 mb-3">
                <label for="status" class="form-label">状态</label>
                <select id="status" name="status" class="form-select">
                  <option value="pending">待处理</option>
                  <option value="approved">已批准</option>
                  <option value="rejected">已拒绝</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label for="description" class="form-label">描述</label>
              <textarea id="description" name="description" class="form-control" placeholder="描述" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">附件 (PDF)</label>
              <input id="attachments" name="attachments" type="file" accept=".pdf" multiple class="form-control">
              <div id="attachmentPreview" class="attachment-preview mt-2"></div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
              <button type="button" class="btn btn-outline-primary" id="recognizeInvoiceNumberBtn"><i class="bi bi-search"></i> 识别发票号码</button>
              <div>
                <button class="btn btn-secondary me-2" data-bs-dismiss="modal">关闭</button>
                <button id="saveInvoiceBtn" class="btn btn-primary" type="submit">保存</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- 确认删除模态框 -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteModalLabel">确认删除</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          您确定要删除此发票吗？此操作不可撤销。
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 批量操作悬浮按钮 -->
  <div id="batchTotalAmount" class="btn btn-light shadow-lg batch-info-btn" style="position:fixed;bottom:130px;right:20px;z-index:1050;display:none;">
    <i class="bi bi-currency-dollar"></i> <span id="totalAmountValue">0.00</span>
  </div>
  <div id="batchCount" class="btn btn-light shadow-lg batch-info-btn" style="position:fixed;bottom:80px;right:20px;z-index:1050;display:none;">
    <i class="bi bi-check-square"></i> <span id="selectedCount">0</span>
  </div>
  <div id="batchActions" class="btn-group shadow-lg">
    <select id="batchStatusSelect" class="form-select me-2" style="width: auto;">
      <option value="">选择状态</option>
      <option value="pending">待处理</option>
      <option value="approved">已批准</option>
      <option value="rejected">已拒绝</option>
    </select>
    <button id="batchSetStatusBtn" class="btn btn-warning d-flex align-items-center"><i class="bi bi-arrow-repeat me-1"></i> <span>设置状态</span></button>
    <button id="batchDeleteBtn" class="btn btn-danger d-flex align-items-center"><i class="bi bi-trash-fill me-1"></i> <span>删除</span></button>
    <button id="batchDownloadBtn" class="btn btn-info d-flex align-items-center"><i class="bi bi-download me-1"></i> <span>下载</span></button>
    <button id="deselectAllBtn" class="btn btn-secondary d-flex align-items-center"><i class="bi bi-x-circle me-1"></i> <span>取消</span></button>
  </div>

  <!-- 依赖 -->
  <script src="https://s4.zstatic.net/ajax/libs/bootstrap/5.3.8/js/bootstrap.bundle.min.js" integrity="sha512-HvOjJrdwNpDbkGJIG2ZNqDlVqMo77qbs4Me4cah0HoDrfhrbA+8SBlZn1KrvAQw7cILLPFJvdwIgphzQmMm+Pw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://s4.zstatic.net/ajax/libs/pocketbase/0.26.2/pocketbase.umd.min.js" integrity="sha512-23hTPP5Tt6X+FXEQTtMkxAI7sRyPG0lUvhTsoAgYn8nFZ0jMO7ZFo7Qy9xKUyKbQ2dWUo8pvkXeVcta8on3d4Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://s4.zstatic.net/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://s4.zstatic.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-Qlv6VSKh1gDKGoJbnyA5RMXYcvnpIqhO++MhIM2fStMcGT9i2T//tSwYFlcyoRRDcDZ+TYHpH8azBBCyhpSeqw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://s4.zstatic.net/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-q+4liFwdPC/bNdhUpZx6aXDx/h77yEQtn4I1slHydcbZK34nLaR3cAeYSJshoxIOq3mjEf7xJE8YWIUHMn+oCQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://s4.zstatic.net/ajax/libs/flatpickr/4.6.13/flatpickr.min.js" integrity="sha512-K/oyQtMXpxI4+K0W7H25UopjM8pzq0yrVdFdG21Fh5dBe91I40pDd9A4lzNlHPHBIP2cwZuoxaUSX0GJSObvGA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://s4.zstatic.net/ajax/libs/flatpickr/4.6.13/l10n/zh.min.js" integrity="sha512-KU9LjAMoAxs8u2DU62DsIID671imkYuyOkE0/wbjVZDRM259WxX5IhQsWTTBMhtdnhviZEqfkdhG09k7JVf9pg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://s4.zstatic.net/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    pdfjsLib.GlobalWorkerOptions.cMapUrl = './cmaps/';
    pdfjsLib.GlobalWorkerOptions.cMapPacked = true;
  </script>

  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <!-- Toast messages will be appended here -->
  </div>

  <!-- 业务脚本 -->
  <script>
    document.write('<script type="module" src="js/app.js?v=' + Math.random() + '" crossorigin="anonymous"></scr' + 'ipt>');
  </script>
</body>
</html>
